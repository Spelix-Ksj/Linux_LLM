# 02. 서버 환경 확인 및 기본 설정

> **이 문서를 읽으면**: SSH로 서버에 접속하고, GPU 상태를 확인하고, 필수 패키지를 설치하여 서버를 프로젝트 작업이 가능한 상태로 만들 수 있습니다.
> **소요 시간**: 약 30분
> **선행 조건**: [01-프로젝트 개요](./01-ARCHITECTURE.md)
> **관련 스크립트**: deploy/02_server_setup.sh

---

## 목차

1. [SSH 접속](#1-ssh-접속)
2. [GPU/CUDA 상태 확인](#2-gpucuda-상태-확인)
3. [NVLink 연결 확인](#3-nvlink-연결-확인)
4. [시스템 필수 패키지 설치](#4-시스템-필수-패키지-설치)
5. [방화벽 포트 개방](#5-방화벽-포트-개방)
6. [확인 체크리스트](#6-확인-체크리스트)

---

## 1. SSH 접속

SSH(Secure Shell)는 원격 서버에 안전하게 접속하기 위한 프로토콜입니다. Windows에서 리눅스 서버에 접속할 때 사용합니다.

### 1-1. 기본 접속 방법

Windows PowerShell 또는 명령 프롬프트를 열고 다음 명령어를 입력합니다.

```bash
ssh root@192.168.10.40
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | IP 주소 `192.168.10.40` 서버에 `root` 계정으로 SSH 접속합니다 |
| **기대 결과** | 비밀번호 입력 프롬프트가 나타나고, 입력 후 `[root@서버이름 ~]#` 형태의 쉘이 표시됩니다 |
| **실패 시 대처** | `Connection refused` — 서버가 꺼져 있거나 SSH 서비스가 중지된 상태입니다. 서버 관리자에게 문의합니다. `Connection timed out` — 네트워크 문제입니다. 같은 네트워크에 연결되어 있는지 확인합니다 |

> **초보자 참고**: 비밀번호를 입력할 때 화면에 아무것도 표시되지 않는 것은 정상입니다. 보안을 위해 의도적으로 숨기는 것이므로 그대로 입력 후 Enter를 누르면 됩니다.

### 1-2. SSH 키 설정 (비밀번호 없이 접속하기)

매번 비밀번호를 입력하지 않고 접속하려면 SSH 키를 설정합니다.

**Step 1: Windows에서 SSH 키 생성**

```bash
ssh-keygen -t ed25519 -C "text2sql-project"
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | Ed25519 알고리즘으로 SSH 키 쌍(공개키 + 개인키)을 생성합니다 |
| **기대 결과** | `C:\Users\사용자이름\.ssh\` 폴더에 `id_ed25519`(개인키)와 `id_ed25519.pub`(공개키) 파일이 생성됩니다 |
| **실패 시 대처** | `.ssh` 폴더가 없다는 오류가 나오면 `mkdir %USERPROFILE%\.ssh`로 폴더를 먼저 생성합니다 |

실행하면 파일 저장 경로와 비밀구문(passphrase)을 물어봅니다. 모두 Enter를 눌러 기본값을 사용해도 됩니다.

**Step 2: 공개키를 서버에 복사**

```bash
ssh-copy-id root@192.168.10.40
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 생성한 공개키를 서버의 `~/.ssh/authorized_keys` 파일에 등록합니다 |
| **기대 결과** | `Number of key(s) added: 1` 메시지가 표시됩니다 |
| **실패 시 대처** | Windows에서 `ssh-copy-id`가 없다면 다음 명령어로 직접 복사합니다: `type %USERPROFILE%\.ssh\id_ed25519.pub | ssh root@192.168.10.40 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"` |

**Step 3: 키 기반 접속 확인**

```bash
ssh root@192.168.10.40
```

비밀번호를 묻지 않고 바로 접속되면 설정이 완료된 것입니다.

---

## 2. GPU/CUDA 상태 확인

이 서버에는 NVIDIA H100 GPU가 5장 설치되어 있습니다. LLM(대규모 언어 모델)을 실행하려면 GPU가 정상적으로 인식되고 있는지 반드시 확인해야 합니다.

### 2-1. nvidia-smi 실행

```bash
nvidia-smi
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | NVIDIA GPU의 상태 정보를 출력합니다. 드라이버 버전, GPU 모델명, 메모리 사용량, 온도, 실행 중인 프로세스 등을 확인할 수 있습니다 |
| **기대 결과** | 5개의 GPU가 표 형태로 출력됩니다 (아래 출력 예시 참조) |
| **실패 시 대처** | `command not found` — NVIDIA 드라이버가 설치되지 않은 상태입니다. `dnf install -y nvidia-driver`로 설치합니다. `NVIDIA-SMI has failed` — 드라이버와 커널 버전이 맞지 않습니다. 서버를 재부팅(`reboot`)한 후 다시 시도합니다 |

### 2-2. 출력 읽는 법

`nvidia-smi` 출력은 크게 두 부분으로 나뉩니다.

**상단: GPU 정보 테이블**

```
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 550.xx.xx    Driver Version: 550.xx.xx    CUDA Version: 12.x                |
+-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|=========================================+========================+======================|
|   0  NVIDIA H100 80GB HBM3         On  | 00000000:XX:00.0   Off |                    0 |
| N/A   30C    P0              72W / 700W |       0MiB / 81559MiB |      0%      Default |
+-----------------------------------------+------------------------+----------------------+
|   1  NVIDIA H100 80GB HBM3         On  | ...                                           |
|   2  NVIDIA H100 80GB HBM3         On  | ...                                           |
|   3  NVIDIA H100 80GB HBM3         On  | ...                                           |
|   4  NVIDIA H100 80GB HBM3         On  | ...                                           |
+-----------------------------------------+------------------------+----------------------+
```

각 항목의 의미는 다음과 같습니다.

| 항목 | 의미 | 정상 범위 |
|------|------|-----------|
| **GPU 번호** (0~4) | GPU의 식별 번호입니다. 총 5장이므로 0부터 4까지 표시됩니다 | 0, 1, 2, 3, 4 모두 표시 |
| **Name** | GPU 모델명입니다 | `NVIDIA H100 80GB HBM3` |
| **Temp** | GPU 온도입니다 | 유휴 상태 25~40도C, 작업 중 50~80도C |
| **Pwr:Usage/Cap** | 현재 전력 사용량 / 최대 전력입니다 | 유휴 시 70~100W, 최대 700W |
| **Memory-Usage** | GPU 메모리 사용량입니다. `사용 중 / 전체` 형식입니다 | 유휴 시 0MiB, 전체 81559MiB (약 80GB) |
| **GPU-Util** | GPU 연산 유닛의 사용률입니다 | 유휴 시 0%, 추론 중 30~90% |

**하단: 프로세스 테이블**

```
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                          GPU Memory     |
|        ID   ID                                                           Usage          |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
```

아직 아무 프로그램도 GPU를 사용하지 않는 상태입니다. vLLM을 실행하면 여기에 프로세스가 표시됩니다.

### 2-3. GPU 개수 빠르게 확인

```bash
nvidia-smi -L
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 시스템에 인식된 GPU 목록만 간단하게 출력합니다 |
| **기대 결과** | 5줄이 출력됩니다. 각 줄은 `GPU 0: NVIDIA H100 80GB HBM3 (UUID: GPU-xxxx...)` 형식입니다 |
| **실패 시 대처** | 5줄 미만이 출력되면 일부 GPU가 인식되지 않는 상태입니다. `lspci | grep -i nvidia`로 하드웨어 수준에서 인식되는지 확인합니다 |

---

## 3. NVLink 연결 확인

NVLink는 GPU 간 고속 데이터 통신을 위한 인터커넥트입니다. 여러 GPU에 모델을 분산 배치(Tensor Parallelism)할 때 NVLink가 연결되어 있으면 성능이 크게 향상됩니다.

### 3-1. GPU 토폴로지 확인

```bash
nvidia-smi topo -m
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | GPU 간 연결 토폴로지(연결 방식)를 매트릭스 형태로 출력합니다 |
| **기대 결과** | 5x5 매트릭스가 출력되며, GPU 간 연결 유형이 표시됩니다 |
| **실패 시 대처** | 출력이 비어있으면 드라이버를 최신 버전으로 업데이트합니다 |

### 3-2. 출력 읽는 법

```
        GPU0    GPU1    GPU2    GPU3    GPU4    CPU Affinity    NUMA Affinity
GPU0     X      NV18    NV18    NV18    SYS     0-63            0
GPU1    NV18     X      NV18    NV18    SYS     0-63            0
GPU2    NV18    NV18     X      NV18    SYS     0-63            0
GPU3    NV18    NV18    NV18     X      SYS     0-63            0
GPU4    SYS     SYS     SYS     SYS      X      64-127          1
```

| 연결 유형 | 의미 |
|-----------|------|
| **NV18** | NVLink 연결 (18개 링크). GPU 간 가장 빠른 통신 방식입니다 |
| **SYS** | PCIe/시스템 버스 연결. NVLink보다 느리지만 통신은 가능합니다 |
| **X** | 자기 자신과의 연결(대각선)입니다 |

> **핵심 포인트**: GPU 0~3은 NVLink로 서로 연결되어 있고, GPU 4는 SYS(PCIe) 연결입니다. 따라서 메인 모델(gpt-oss-120b)은 GPU 0~3에 배치하고(Tensor Parallelism 4), 보조 모델은 GPU 4에 배치합니다. 이렇게 하면 메인 모델이 NVLink의 고속 통신 이점을 최대로 활용할 수 있습니다.

---

## 4. 시스템 필수 패키지 설치

서버에 개발 도구와 라이브러리를 설치합니다. 이 패키지들은 Python, vLLM 등을 설치할 때 필요한 기반 요소입니다.

> **참고**: 이 서버는 RHEL 계열(Rocky Linux / AlmaLinux)을 사용하므로 패키지 관리자로 `dnf`를 사용합니다. Ubuntu의 `apt`와 같은 역할입니다.

### 4-1. 개발 도구 그룹 설치

```bash
dnf groupinstall -y "Development Tools"
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | C/C++ 컴파일러(gcc, g++), make, autoconf 등 개발에 필요한 기본 도구 묶음을 한꺼번에 설치합니다 |
| **기대 결과** | `Complete!` 메시지가 출력됩니다. 이미 설치되어 있으면 `Nothing to do` 메시지가 표시됩니다 |
| **실패 시 대처** | `No match for group` — `dnf group list`로 사용 가능한 그룹 이름을 확인합니다. 네트워크 오류 — `ping 8.8.8.8`으로 인터넷 연결을 확인합니다 |

**왜 필요한가**: Python 패키지 중 일부(예: `psutil`, `tokenizers`)는 설치 시 C 코드를 컴파일합니다. 컴파일러가 없으면 설치에 실패합니다.

### 4-2. 개별 필수 패키지 설치

```bash
dnf install -y git wget curl bzip2 libffi-devel openssl-devel
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 6개의 필수 패키지를 설치합니다 |
| **기대 결과** | `Complete!` 메시지가 출력됩니다 |
| **실패 시 대처** | 특정 패키지를 찾을 수 없다면 `dnf search 패키지이름`으로 정확한 이름을 확인합니다 |

각 패키지의 역할은 다음과 같습니다.

| 패키지 | 용도 |
|--------|------|
| **git** | 소스 코드 버전 관리 도구입니다. 프로젝트 코드를 다운로드하고 관리하는 데 사용합니다 |
| **wget** | URL에서 파일을 다운로드하는 명령줄 도구입니다. Miniconda 설치 파일 등을 받을 때 사용합니다 |
| **curl** | URL과 데이터를 주고받는 도구입니다. API 테스트(vLLM 동작 확인 등)에 사용합니다 |
| **bzip2** | 파일 압축/해제 도구입니다. Miniconda 설치 파일이 bzip2로 압축되어 있습니다 |
| **libffi-devel** | Foreign Function Interface 라이브러리의 개발 헤더입니다. Python의 `ctypes` 모듈이 이 라이브러리에 의존합니다 |
| **openssl-devel** | SSL/TLS 암호화 라이브러리의 개발 헤더입니다. Python의 `ssl` 모듈과 `pip`의 HTTPS 통신에 필요합니다 |

> **`-y` 옵션이란?**: 설치 과정에서 "정말 설치할까요? [y/N]" 질문에 자동으로 "y"(예)를 입력하는 옵션입니다. 생략하면 설치 중 확인 질문이 표시됩니다.

---

## 5. 방화벽 포트 개방

서버의 방화벽은 기본적으로 SSH(22번 포트)만 허용합니다. vLLM API와 Gradio 웹 인터페이스에 접속하려면 해당 포트를 열어야 합니다.

### 5-1. 개방할 포트 목록

| 포트 | 프로토콜 | 용도 |
|------|----------|------|
| **7860** | TCP | Gradio 웹 UI입니다. 브라우저에서 Text2SQL 인터페이스에 접속할 때 사용합니다 |
| **8000** | TCP | vLLM 메인 모델(gpt-oss-120b)의 API 서버입니다. OpenAI 호환 API를 제공합니다 |
| **8001** | TCP | vLLM 보조 모델(Qwen3-Coder-30B)의 API 서버입니다 (선택사항) |

### 5-2. 포트 개방 명령어

**Gradio 포트 (7860)**

```bash
firewall-cmd --permanent --add-port=7860/tcp && firewall-cmd --reload
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 방화벽에 TCP 7860번 포트를 영구적으로 개방하고, 변경 사항을 즉시 적용합니다 |
| **기대 결과** | `success`가 두 번 출력됩니다 (첫 번째는 규칙 추가, 두 번째는 리로드) |
| **실패 시 대처** | `FirewallD is not running` — 방화벽 서비스가 꺼져 있습니다. `systemctl start firewalld`로 시작합니다. `ALREADY_ENABLED` — 이미 해당 포트가 열려 있습니다. 정상이므로 무시해도 됩니다 |

**vLLM 메인 모델 포트 (8000)**

```bash
firewall-cmd --permanent --add-port=8000/tcp && firewall-cmd --reload
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 방화벽에 TCP 8000번 포트를 영구적으로 개방하고, 변경 사항을 즉시 적용합니다 |
| **기대 결과** | `success`가 두 번 출력됩니다 |
| **실패 시 대처** | 위와 동일합니다 |

**vLLM 보조 모델 포트 (8001)**

```bash
firewall-cmd --permanent --add-port=8001/tcp && firewall-cmd --reload
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 방화벽에 TCP 8001번 포트를 영구적으로 개방하고, 변경 사항을 즉시 적용합니다 |
| **기대 결과** | `success`가 두 번 출력됩니다 |
| **실패 시 대처** | 위와 동일합니다 |

> **`--permanent`란?**: 이 옵션 없이 실행하면 방화벽을 재시작하거나 서버를 재부팅할 때 설정이 사라집니다. `--permanent`를 붙이면 영구적으로 저장되지만, 즉시 적용되지는 않습니다. 그래서 `firewall-cmd --reload`를 함께 실행하는 것입니다.

### 5-3. 개방 상태 확인

```bash
firewall-cmd --list-ports
```

| 항목 | 설명 |
|------|------|
| **무엇을 하는 명령인가** | 현재 방화벽에서 열려 있는 포트 목록을 출력합니다 |
| **기대 결과** | `7860/tcp 8000/tcp 8001/tcp` (순서는 다를 수 있습니다) |
| **실패 시 대처** | 목록에 포트가 없으면 위의 개방 명령어를 다시 실행합니다 |

---

## 6. 확인 체크리스트

다음 단계로 넘어가기 전에 모든 항목을 확인합니다.

| 순번 | 확인 항목 | 확인 명령어 | 기대 결과 |
|------|-----------|-------------|-----------|
| 1 | SSH 접속 가능 | `ssh root@192.168.10.40` | 비밀번호 없이 쉘 진입 |
| 2 | GPU 5장 인식 | `nvidia-smi -L` | 5줄 출력 (GPU 0~4) |
| 3 | NVLink 확인 | `nvidia-smi topo -m` | GPU 0~3 간 NV18 연결 |
| 4 | 개발 도구 설치 | `gcc --version` | 버전 정보 출력 |
| 5 | 필수 패키지 설치 | `git --version && wget --version` | 각각 버전 정보 출력 |
| 6 | 방화벽 포트 | `firewall-cmd --list-ports` | 7860, 8000, 8001 포함 |

모든 항목이 확인되면 다음 문서로 진행합니다.

---
## 문서 탐색
| 이전 | 목차 | 다음 |
|------|------|------|
| [이전](./01-ARCHITECTURE.md) | [00-전체 안내](./00-INDEX.md) | [다음](./03-PYTHON-ENV.md) |
