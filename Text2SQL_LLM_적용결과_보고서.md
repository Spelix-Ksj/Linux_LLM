# Text2SQL LLM 적용 결과 보고서

**시스템**: HDTP(현대백화점 정기인사 전환배치 최적화) Text2SQL
**작성일**: 2026-02-26
**버전**: v1.0

---

## 1. 개요

### 1.1 프로젝트 배경
HDTP(정기인사 전환배치 최적화) 시스템의 Oracle 데이터베이스에 저장된 인사 배치 데이터를 비개발자도 활용할 수 있도록, 자연어 질문을 Oracle SQL로 자동 변환하여 실행하는 Text2SQL 시스템을 구축하였다.

### 1.2 시스템 목적
- **자연어 질의**: "직급별 인원 수를 알려줘" 같은 한국어 질문을 Oracle SQL SELECT문으로 자동 변환
- **즉시 실행**: 생성된 SQL을 Oracle DB에서 실행하여 결과를 웹 UI에 표시
- **결과 분석**: LLM이 쿼리 결과를 자동 요약하는 보고서 생성 기능 제공

### 1.3 기술 스택
| 구분 | 기술 | 상세 |
|------|------|------|
| LLM 서빙 | vLLM | H100 GPU 5장 (Rocky Linux 9.6) |
| 메인 모델 | gpt-oss-120b | GPU 0-3, Tensor Parallel 4 |
| 보조 모델 | Qwen3-Coder-30B | GPU 4, MoE 30B (활성 3B) |
| 데이터베이스 | Oracle | HRAI_CON 스키마, 62개 테이블 |
| 웹 UI | Gradio 6.6 | 모델 선택, SQL 편집, 결과 그리드 |
| 파이프라인 | LangChain | ChatOpenAI + SQLDatabase 연동 |

---

## 2. 시스템 구성

### 2.1 서버 아키텍처
```
[사용자 브라우저] ──HTTP──▶ [Gradio 웹 UI (port 7860)]
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
         [vLLM: gpt-oss-120b]  [vLLM: Qwen3-Coder-30B]
           port 8000 (TP4)       port 8001 (GPU 4)
                    │
                    ▼
          [Oracle DB: HISTPRD]
          HRAI_CON 스키마 (62개 테이블)
```

### 2.2 SQL 생성 파이프라인
1. **SYSTEM_PROMPT 구성**: 도메인 지식(시스템 개요, 15개 테이블 스키마, 5개 JOIN 패턴) + 규칙 13개 + Few-shot 6개
2. **LLM 호출**: 사용자 질문을 SystemMessage + HumanMessage로 전달
3. **SQL 후처리**: 코드 블록 추출, 세미콜론 제거, SELECT/WITH 시작점 파싱
4. **안전성 검사**: INSERT/UPDATE/DELETE/DROP 등 위험 키워드 차단
5. **SQL 실행**: ROWNUM <= 1000 제한 래핑, 30초 타임아웃
6. **결과 보고**: 2차 LLM 호출로 결과를 자연어 보고서로 변환

### 2.3 핵심 테이블 구조 (15개)
| 영역 | 테이블 | 설명 | 비고 |
|------|--------|------|------|
| 이동기준 | ftr_move_std | 이동번호별 기준정보 마스터 | 공통 조인 키 |
| 직원 | move_item_master | 전환배치대상자 (76개 컬럼) | 직원 마스터 |
| 직원 | move_item_detail | 발령정보 (메일 발송) | 복합 PK |
| 조직 | move_org_master | 사업소/조직 계층 (LVL1~5) | 조직 마스터 |
| 조직 | move_network_change | 사업소 변경 이력 | 조직 개편 |
| 케이스 | move_case_master | 배치 시나리오 케이스 | 케이스 관리 |
| 케이스 | move_case_detail | 리비전별 상세 (REV_ID) | 리비전 관리 |
| 케이스 | move_case_item | 직원별 배치 결과 | 핵심 결과 테이블 |
| 케이스 | move_case_org | 조직별 TO 배정 | 정원 관리 |
| 제약 | move_case_cnst_master | 48개 제약코드 설정 | 최적화 제약 |
| 제약 | move_case_penalty_info | 감점 상세 정보 | 위반/감점 |
| 제약 | move_jobtype_penalty_matrix | 직무 호환성 매트릭스 | 직종 감점 |
| 제약 | move_stay_rule | 필수유보 이동기준 | 잔류 규칙 |
| 제약 | move_emp_exclusion | 동시배치불가 직원 쌍 | 부부/징계 |
| ML | ml_map_dictionary | ML 직무분류 매핑 | 매핑 사전 |

---

## 3. 테스트 LLM 모델 비교

### 3.1 모델별 평가 결과

| 모델 | 파라미터 | 특징 | Text2SQL 정확도 | Oracle 호환 | 판정 |
|------|---------|------|----------------|------------|------|
| gpt-oss-120b | 117B MoE | 범용 추론 | 약 55-62% (BIRD 추정) | O (범용) | **메인 채택** |
| Qwen3-Coder-30B | 30B MoE (활성 3B) | 코딩 특화 | 약 75% (4건 테스트) | O (범용) | 보조/테스트 |
| EXAONE-Deep-32B | 32B | 한국어 특화 | 약 40% (쿼리 오류 지속) | O (범용) | **성능 부족 (사용 불가)** |
| Arctic-Text2SQL-R1-7B | 7B | Text2SQL 전문 (BIRD 68.9%) | 높음 (SQLite) | **X (SQLite 전용)** | **Oracle 비호환** |

### 3.2 핵심 발견사항

**Text2SQL 벤치마크 점수와 실전 Oracle 환경 성능은 별개의 문제이다.**

- BIRD/Spider 등 주요 벤치마크는 100% SQLite 기반으로 구성되어 있음
- Oracle 고유 문법(NVL, DECODE, ROWNUM, FETCH FIRST, 복합 PK, VARCHAR2 타입 비교 등)을 벤치마크에서는 평가하지 않음
- Arctic-Text2SQL-R1-7B는 BIRD 벤치마크에서 68.9%의 우수한 성적을 기록했으나, 실제 Oracle 환경에서는 LIMIT, strftime() 등 SQLite 문법을 생성하여 실행 자체가 불가능하였음
- EXAONE-Deep-32B는 초기 max_model_len=8192에서 컨텍스트 초과 문제가 발생하여 16384로 확장 후 추론 테스트에는 성공하였으나, 지속적인 쿼리 오류(잘못된 컬럼명 생성, JOIN 패턴 미준수 등)로 인해 Text2SQL 실전 활용이 불가능하였음

---

## 4. Example 쿼리 테스트 결과 및 오류 분석

### 4.1 전체 정확도 추정
- Example 쿼리 초기 10개 구성 → 31개로 확장 → DB 검증을 거쳐 20개로 교체 → 빈 테이블/NULL 컬럼 등 3건 수정 → 의미없는 데이터 7건 교체를 거쳐 최종 19개 확정
- **실제 테스트 기반 정확도**: 약 55-60% (19개 중 약 11개 정상 실행, 약 8개 오류 발생)
- 단순 단일 테이블 쿼리는 80% 이상 정확도, 복합 JOIN/집계 쿼리는 30-40% 수준

### 4.2 오류 유형별 분류

#### A. DB 스키마 불일치 오류 (가장 빈번, 전체 오류의 약 30%) (실제 발견 사례 약 5건)

LLM이 실제 DB에 존재하지 않는 컬럼명을 생성하거나, C# 런타임 계산 속성을 DB 컬럼으로 착각하는 경우.

| 오류 내용 | 원인 | 영향 |
|----------|------|------|
| stay_cnt, alg_tot_to, move_in_cnt, move_out_cnt 사용 | C# 런타임 속성을 DB 컬럼으로 착각 | ORA-00904 실행 실패 |
| m.org_id 사용 | 실제 컬럼은 m.lvl5_id | ORA-00904 실행 실패 |
| penalty_nm, vio_cnt, opt_val 사용 | 실제는 cnst_nm, penalty_cnt, penalty_sum | ORA-00904 실행 실패 |
| base_ym, use_yn, case_nm, opt_status, rule_nm, stay_mon | 실제 컬럼명과 불일치 | ORA-00904 실행 실패 |

#### B. 데이터 타입 불일치 오류 (전체 오류의 약 20%) (실제 발견 사례 약 4건)

LLM이 컬럼의 실제 데이터 타입을 잘못 추정하여 비교 연산에서 오류가 발생하는 경우.

| 오류 내용 | 원인 | 영향 |
|----------|------|------|
| rev_id = 999 (숫자 비교) | 실제 VARCHAR2 타입이므로 rev_id = '999' 필요 | 암묵적 변환 또는 ORA 오류 |
| must_stay_yn = '1' (문자열 비교) | 실제 NUMBER 타입이므로 = 1 필요 | 인덱스 미사용, 성능 저하 |
| married 컬럼을 Y/N으로 가정 | 실제 값은 1 또는 NULL | 필터링 오류 |
| year_desc를 '30대'로 가정 | 실제 값은 '23', '24' 등 개별 연차 | 조회 0건 |

#### C. LLM 생성 SQL 구조적 오류 (전체 오류의 약 25%) (실제 발견 사례 약 4건)

LLM이 SQL 구문 자체는 유효하나 비즈니스 로직이나 데이터 구조에 맞지 않는 쿼리를 생성하는 경우.

| 오류 내용 | 원인 | 영향 |
|----------|------|------|
| REV_ID='999' 조건 누락 JOIN | 리비전 관리 구조 이해 부족 | 5명 데이터가 100건으로 중복 |
| lvl=3 조건 자의적 추가 | Few-shot에 없는 조건을 LLM이 독자 추론 | 0건 반환 |
| CTE(WITH절) + FULL OUTER JOIN 복합 쿼리 | 단순 SQL은 성공하나 복잡 SQL에서 실패 | 빈 결과 또는 오류 |
| NULL 컬럼 ORDER BY 시 IS NOT NULL 누락 | NULL 값 처리 규칙 미준수 | 부정확한 정렬 결과 |
| SQLite 문법 생성 (Arctic 모델) | LIMIT, strftime() 등 비Oracle 문법 | Oracle 실행 불가 |

#### D. 프롬프트/규칙 충돌 (전체 오류의 약 10%) (실제 발견 사례 약 2건)

SYSTEM_PROMPT 내 규칙 간 모순 또는 규칙 적용 범위의 모호함으로 인해 LLM이 일관되지 않은 SQL을 생성하는 경우.

| 오류 내용 | 원인 | 영향 |
|----------|------|------|
| rev_id='999' 규칙 완화 후 중복 행 발생 | 규칙 11 완화가 데이터 정합성 파괴 | 부정확한 집계 결과 |
| rev_id='999' 필수 적용 시 일부 이동번호에서 0건 | 해당 이동번호에 확정 리비전 미존재 | 빈 결과 |
| JOIN 패턴 헤더와 규칙 11 모순 | "반드시 포함" vs "명시적 요청 시만" | LLM 혼란으로 불일치 |

**[설계 교훈] REV_ID='999' 규칙 3단계 변경 이력:**
1단계(필수 적용): CASE 계열 테이블에 rev_id='999' 조건을 기본 규칙으로 추가
→ 일부 이동번호에서 확정 리비전이 없어 0건 반환 문제 발생

2단계(규칙 완화): "사용자가 명시적으로 요청한 경우에만" rev_id='999' 추가로 변경
→ JOIN 시 리비전별 중복 행이 대량 발생 (5명 데이터가 100건으로 조회)

3단계(규칙 재복원): CASE 계열 5개 테이블에 rev_id='999' 필수 조건 재적용
→ 결론: "데이터가 안 나온다"는 문제는 rev_id 조건 자체가 아닌, 해당 이동번호에 확정 리비전이 존재하지 않기 때문. 프롬프트 규칙 설계 전 반드시 데이터 존재 여부를 사전 검증해야 함.

#### E. 데이터 품질 기인 오류 (전체 오류의 약 15%) (실제 발견 사례 약 4건)

LLM이 생성한 SQL 자체는 정상이나, 대상 테이블/컬럼의 데이터가 NULL이거나 의미 없는 기본값으로 채워져 유의미한 결과를 반환하지 못하는 경우.

| 오류 내용 | 원인 | 영향 |
|----------|------|------|
| org_nm 조회 시 전부 NULL 반환 | 데이터 미입력 (lvl3_nm 사용 필요) | 결과 무의미 |
| fixed_yn 전부 NULL | 데이터 미입력 | 0건 반환 |
| c_area_work_mon 전부 1 | 의미 없는 기본값 | 분석 불가 |
| move_emp_exclusion 테이블 0건 | 데이터 미입력 (빈 테이블) | 0건 반환 |

#### [참고] 의미없는 Example 7건 대량 교체 사건 (2026-02-26)
DB 라이브 검증 과정에서 다음 4개 컬럼의 데이터 값 도메인 오해로 인해 7개 Example이 무의미한 결과를 반환하는 것이 발견되었다:
- `c_area_work_mon`: 전수 1 (의미없는 기본값, 권역 장기 근무 분석 불가)
- `org_nm`: 전수 NULL (lvl3_nm에 실제 조직명 존재)
- `married`: 1 또는 NULL (Y/N이 아님)
- `year_desc`: '23', '24', '25' 등 개별 연차 (연령대가 아님)

이로 인해 "전체 직원 수", "30대 직원 목록", "권역별 직원 수" 등 7개 Example을 "직급별 평균 조직근무개월", "종합점수 TOP 10", "연령대별 직급 분포" 등 DB 검증된 유의미한 쿼리로 교체하였다.

---

## 5. Text2SQL 시스템의 한계

### 5.1 근본적 한계

**1) DB 스키마 학습의 어려움**
- HDTP Oracle DB는 물리적 Foreign Key가 설정되어 있지 않으며, 테이블 간 관계는 암묵적 조인 패턴에 의존
- move_item_master 테이블은 76개 컬럼으로 구성되어 LLM이 컬럼 용도를 정확히 구분하기 어려움
- C# 애플리케이션에서 런타임 계산하는 속성(stay_cnt, alg_tot_to 등)과 실제 DB 컬럼의 구분이 불가능

**2) 도메인 지식 의존성**
- HDTP는 인사 배치 최적화 전문 시스템으로, "리비전(REV_ID)", "케이스(CASE_ID)", "이동번호(FTR_MOVE_STD_ID)", "감점(PENALTY)" 등 업무 용어에 대한 정확한 이해가 없으면 올바른 SQL 생성이 불가능
- 특히 리비전 관리 체계(REV_ID='999'가 최종 확정)는 HDTP 고유 설계이므로 LLM이 사전 학습에서 이를 알 수 없음

**3) 데이터 품질 문제**
- org_nm 컬럼이 전수 NULL (lvl3_nm에 실제 조직명 존재)
- fixed_yn 컬럼이 전수 NULL (확정 여부 데이터 미입력)
- c_area_work_mon 컬럼이 전수 1 (의미 없는 기본값)
- move_emp_exclusion 테이블이 0건 (동시배치불가 데이터 미입력)

**4) 복잡 쿼리 한계**
- CTE(WITH절), FULL OUTER JOIN, 다중 서브쿼리 등 복잡한 SQL 구조에서 정확도가 급격히 하락
- 단순 SELECT + WHERE 쿼리 대비 복합 JOIN + 집계 쿼리의 정확도 차이가 약 40-50%p

### 5.2 벤치마크와 실전의 괴리

| 비교 항목 | BIRD/Spider 벤치마크 | HDTP 실전 환경 |
|----------|---------------------|---------------|
| DB 엔진 | SQLite | Oracle |
| 스키마 복잡도 | 단순 (FK 명시) | 복합 PK 5개, FK 없음 |
| 질문 언어 | 영어 | 한국어 |
| 도메인 | 범용 (학교, 쇼핑몰 등) | 인사 배치 최적화 전문 |
| 컬럼 수 | 5-20개/테이블 | 최대 76개/테이블 |
| 데이터 타입 | 단순 (TEXT, INTEGER) | VARCHAR2, NUMBER, 암묵적 변환 |
| 테이블 관계 | FK로 명시 | 암묵적 조인 패턴 |

### 5.3 Oracle SQL 전용 모델 부재
- 현존하는 Text2SQL 오픈소스 모델(Arctic, DAIL-SQL, DIN-SQL, C3SQL 등)은 100% SQLite 기반 학습
- Oracle SQL 전용 Text2SQL 파인튜닝 모델은 오픈소스 및 상용 시장 모두에서 현재 존재하지 않음
- 범용 LLM(gpt-oss-120b)에 프롬프트 엔지니어링(도메인 지식 + 규칙 + Few-shot)을 적용하는 것이 현재 시점에서 최선의 접근 방식

---

## 6. 개선 방안

### 6.1 단기 개선 - 프롬프트 엔지니어링 (1-2주)

| 항목 | 현재 상태 | 권장 액션 |
|------|----------|----------|
| SYSTEM_PROMPT 도메인 지식 | 15개 테이블, 5개 JOIN 패턴 반영 완료 | 유지 |
| Few-shot 예시 | 6개 구성 완료 | 15-20개로 확충 (복합 JOIN, 집계 패턴 추가) |
| 규칙 | 13개 구성 완료 | 네거티브 Few-shot 추가 ("이렇게 하지 마세요" 패턴) |
| 컬럼 설명 | 주요 컬럼만 기술 | 오류 빈발 컬럼의 데이터 타입/실제 값 명시 |

### 6.2 중기 개선 - 시스템 아키텍처 (1-3개월)

**1) SQL 사후 검증 레이어**
- 생성된 SQL 실행 전 컬럼 존재 여부, 데이터 타입 적합성 자동 검증
- Oracle DESCRIBE 명령 기반 메타데이터 캐시와 대조

**2) 오류 자동 복구 (Self-Correction)**
- SQL 실행 오류 발생 시 ORA 에러 메시지를 LLM에 피드백하여 수정된 SQL 재생성
- 최대 2회 재시도로 정확도 10-15%p 개선 기대

**3) SQLGlot 변환 레이어**
- SQLite 전문 모델(Arctic 등)이 생성한 SQLite SQL을 Oracle SQL로 자동 변환
- sqlglot 라이브러리의 transpile 기능 활용 (LIMIT -> FETCH FIRST, strftime -> TO_CHAR 등)
- 다만, 파인튜닝 수준에서 SQLite 문법이 고착된 모델은 SQLGlot만으로는 완전한 Oracle 호환이 어려우며, JOIN 패턴이나 Oracle 고유 함수까지 변환하려면 추가적인 후처리가 필요하다.

**4) 쿼리 캐싱**
- 빈출 질문-SQL 매핑을 캐시하여 LLM 호출 없이 즉시 반환
- 동일/유사 질문에 대한 응답 시간 단축 및 일관성 확보

### 6.3 장기 개선 - 모델 파인튜닝 (6개월+)

**1) Oracle SQL 파인튜닝 데이터셋 구축**
- HDTP 스키마 기반 질문-SQL 쌍 500-1,000개 수동 구축
- 업무 담당자 인터뷰를 통한 실제 업무 질문 수집

**2) LoRA/QLoRA 미세 조정**
- gpt-oss-120b 또는 Qwen3-Coder를 HDTP 도메인 + Oracle SQL로 파인튜닝
- 4-bit 양자화(QLoRA)로 H100 단일 GPU에서도 학습 가능

**3) ExeSQL 강화학습**
- SQL 실행 결과(성공/실패)를 보상 신호로 사용하는 GRPO 기반 강화학습
- "컴파일 가능한 SQL"뿐 아니라 "정확한 결과를 반환하는 SQL"까지 최적화

**4) RAG(Retrieval-Augmented Generation)**
- 스키마 DDL, 업무 매뉴얼, 기존 정답 SQL을 벡터 DB에 저장
- 질문 유사도 기반으로 관련 스키마 정보와 유사 SQL을 동적 참조

---

## 7. 솔루션별 DB 스키마 및 업무 로직 학습 필요성

Text2SQL 시스템의 실용적 정확도(80% 이상)를 달성하기 위해서는 솔루션(고객사 시스템)별로 다음 6개 영역의 학습이 필수적이다.

| 항목 | 현재 수준 | 필요 수준 | 갭(Gap) |
|------|----------|----------|---------|
| 테이블 구조 | SYSTEM_PROMPT에 15개 테이블 기술 | DDL 기반 전수 컬럼 검증 | 잘못된 컬럼명 다수 발견 |
| 데이터 타입 | 일부만 파악 (REV_ID VARCHAR2 등) | 전체 컬럼 타입 매핑 | 타입 불일치 오류 빈번 |
| 데이터 품질 | 미파악 | NULL/빈값/무의미값 전수 조사 | org_nm=NULL 등 미파악 |
| JOIN 관계 | 5개 패턴 정의 | 물리적 FK 없어 논리적 관계 전수 파악 | 암묵적 조인 패턴 누락 |
| 업무 로직 | 기본 프로세스 파악 | 48개 제약조건, 감점 체계, 리비전 관리 상세 | 리비전/확정 로직 이해 부족 |
| 데이터 값 도메인 | 일부 (권역 A~E) | 모든 코드값, ENUM 컬럼의 실제 값 | year_desc, married 등 미파악 |

이는 HDTP뿐 아니라 모든 Oracle 기반 솔루션에 공통으로 적용되는 요구사항이다. Text2SQL을 새로운 솔루션에 적용할 때마다 위 6개 영역에 대한 사전 조사 및 SYSTEM_PROMPT 반영이 선행되어야 한다.

---

## 8. 결론

### 8.1 성과 요약
- 로컬 LLM(gpt-oss-120b) 기반 Text2SQL 시스템을 성공적으로 구축하여 운영 가능한 수준의 프로토타입을 확보하였다.
- 단순 단일 테이블 쿼리(직급별 인원 수, 근무기간 TOP 10 등)에서는 80% 이상의 정확도를 달성하였다.
- 프롬프트 엔지니어링(도메인 지식 + 규칙 13개 + Few-shot 6개)만으로 범용 LLM의 Oracle SQL 생성 능력을 유의미하게 향상시켰다.

### 8.2 현재 한계
- **전체 정확도**: 약 55-60% (복합 쿼리 포함 시)
- **최대 장애물**: DB 스키마 정보 부정확 (C# 런타임 속성과 DB 컬럼 혼동, 데이터 품질 미검증)
- **모델 한계**: Oracle SQL 전용 Text2SQL 모델이 존재하지 않으며, 범용 LLM의 프롬프트 엔지니어링에 의존

### 8.3 핵심 교훈
Text2SQL은 "LLM 모델 성능"만으로 결정되지 않는다. **DB 스키마 정확성**, **데이터 품질**, **도메인 지식**이 삼위일체로 갖추어져야 실용적 정확도(80% 이상)에 도달할 수 있다. 벤치마크(BIRD/Spider)에서의 높은 점수가 실전 Oracle 환경에서의 성능을 보장하지 않는다는 점이 이번 프로젝트의 가장 중요한 발견이다.

### 8.4 권장 액션 로드맵

| 시기 | 액션 | 기대 효과 |
|------|------|----------|
| 즉시 (1-2주) | DDL 기반 스키마 전수 검증 + 실제 데이터 값 도메인 조사 | 스키마 불일치 오류 50% 감소 |
| 단기 (1-3개월) | SQL 사후 검증 + 오류 자동 복구 + Few-shot 20개 확충 | 전체 정확도 70-75% 도달 |
| 중기 (3-6개월) | SQLGlot 변환 레이어 + 쿼리 캐싱 + RAG 도입 | 응답 속도 향상 + 정확도 75-80% |
| 장기 (6개월+) | Oracle SQL 파인튜닝 데이터셋 구축 + LoRA 미세 조정 | 정확도 80-85% 목표 |

---

*본 보고서는 2026년 2월 기준 Text2SQL 시스템의 적용 결과를 정리한 것으로, 향후 모델 업데이트 및 시스템 개선에 따라 수치가 변동될 수 있습니다.*
